name: Production Release (Google Play App Signing)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  release:
    name: Release to Google Play
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'zulu'
            cache: gradle

        - name: Cache Gradle dependencies
          uses: actions/cache@v4
          with:
            path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
            restore-keys: |
              ${{ runner.os }}-gradle-

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Bump version
          uses: chkfung/android-version-actions@v1.1
          with:
            gradlePath: androidApp/build.gradle.kts
            versionCode: ${{ github.run_number }}
            versionName: ${{ format('2.1.{0}', github.run_number ) }}

        # Option 1: Use debug signing (Google will re-sign)
        - name: Build release bundle (debug signed)
          run: ./gradlew :androidApp:bundleRelease
          # No signing configuration needed - Google will handle it

        # Option 2: Use upload key (if you have one configured)
        # - name: Decode upload key
        #   run: |
        #     echo "${{ secrets.UPLOAD_KEY_BASE64 }}" | base64 -d > androidApp/upload-key.jks
        #
        # - name: Build release bundle (upload key signed)
        #   run: ./gradlew :androidApp:bundleRelease
        #   env:
        #     UPLOAD_KEY_PASSWORD: ${{ secrets.UPLOAD_KEY_PASSWORD }}
        #     UPLOAD_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
        #     UPLOAD_ALIAS_PASSWORD: ${{ secrets.UPLOAD_ALIAS_PASSWORD }}

        - name: Upload to Google Play Store
          uses: r0adkll/upload-google-play@v1.1.1
          with:
            serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_GP }}
            packageName: ru.dinarastepina.decomposedictionary
            releaseFiles: androidApp/build/outputs/bundle/release/androidApp-release.aab
            track: internal
            status: completed

        - name: Upload release bundle
          uses: actions/upload-artifact@v4
          with:
            name: release-bundle
            path: androidApp/build/outputs/bundle/release/*.aab 